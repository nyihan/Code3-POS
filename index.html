<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SmartPOS</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#007aff" />
<link rel="icon" href="icons/icon-192.png" />

<style>
:root {
  --accent: #007aff;
  --accent-dark: #0056b3;
  --bg: #f5f6fa;
  --white: #fff;
  --gray: #ddd;
  --text: #333;
}
html, body {
  margin: 0; padding: 0; height: 100%;
  font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg); color: var(--text);
}
.loader {display:flex;align-items:center;justify-content:center;height:100vh;}
.pos-header {
  position:fixed;top:0;left:0;right:0;height:55px;
  background:var(--accent);color:#fff;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 1rem;z-index:1000;
}
.pos-tabs {
  position:fixed;top:55px;left:0;right:0;
  background:#fff;border-bottom:1px solid var(--gray);
  display:flex;z-index:999;
}
.pos-tabs button {
  flex:1;padding:0.75rem;border:none;background:none;cursor:pointer;font-size:1rem;
}
.pos-tabs button.active {
  border-bottom:3px solid var(--accent);color:var(--accent);font-weight:bold;
}
#tab-content {
  margin-top:110px;padding:1rem;height:calc(100vh - 110px);overflow-y:auto;
}
.btn {
  background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:5px;cursor:pointer;
}
.btn:hover {background:var(--accent-dark);}
.table {width:100%;border-collapse:collapse;margin-top:10px;}
.table th,.table td{border:1px solid #ddd;padding:6px;}
.table th{background:var(--accent);color:#fff;}
.item-card{display:flex;justify-content:space-between;background:#fff;margin-bottom:6px;padding:10px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.1);cursor:pointer;}
.item-card:hover{background:#f2f2f7;}
.ticket-panel{background:#fff;border-radius:8px;margin-top:10px;padding:10px;}
.ticket-item{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;}
.ticket-summary{display:flex;justify-content:space-between;margin-top:5px;font-weight:bold;}
.checkout-btn{width:100%;background:var(--accent);color:#fff;padding:10px;border:none;border-radius:6px;cursor:pointer;margin-top:10px;}
.checkout-btn:hover{background:var(--accent-dark);}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:2000;}
.modal.active{display:flex;}
.modal-content{background:#fff;padding:1rem;border-radius:6px;width:90%;max-width:400px;}
</style>
</head>

<body>
<div class="loader"><h2>SmartPOS Loading...</h2></div>

<div id="app" style="display:none">
  <header class="pos-header">
    <h1>SmartPOS</h1>
    <button id="btn-settings">⚙️</button>
  </header>

  <nav class="pos-tabs">
    <button data-tab="sales" class="active">Sales</button>
    <button data-tab="items">Items</button>
    <button data-tab="categories">Categories</button>
    <button data-tab="receipts">Receipts</button>
  </nav>

  <main id="tab-content"></main>
</div>

<!-- Receipt Detail Modal -->
<div class="modal" id="receiptModal">
  <div class="modal-content">
    <h3 id="receiptTitle">Receipt Detail</h3>
    <div id="receiptItems"></div>
    <div style="margin-top:10px;font-weight:bold;">
      Total: <span id="receiptTotal"></span>
    </div>
    <div style="text-align:right;margin-top:15px;">
      <button class="btn" onclick="closeReceipt()">Close</button>
    </div>
  </div>
</div>

<script>
let appData = { items: [], categories: [], receipts: [] };
let ticket = [];

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  document.querySelector(".loader").style.display="none";
  document.querySelector("#app").style.display="block";
  loadLocal();
  initTabs();
  renderSales();
});

/* Storage */
function saveLocal(){localStorage.setItem("smartpos-data",JSON.stringify(appData));}
function loadLocal(){const raw=localStorage.getItem("smartpos-data");if(raw)appData=JSON.parse(raw);}

/* Tabs */
function initTabs(){
  const tabs=document.querySelectorAll(".pos-tabs button");
  tabs.forEach(b=>b.onclick=()=>{
    tabs.forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const t=b.dataset.tab;
    if(t==="sales")renderSales();
    if(t==="items")renderItems();
    if(t==="categories")renderCategories();
    if(t==="receipts")renderReceipts();
  });
}

/* SALES TAB */
function renderSales(){
  const main=document.querySelector("#tab-content");
  let html=`<h2>Sales</h2><div id='salesList'>`;
  appData.items.forEach(it=>{
    html+=`<div class='item-card' onclick="addToTicket('${it.id}')"><span>${it.name}</span><span>Ks ${it.price}</span></div>`;
  });
  html+=`</div><div class='ticket-panel' id='ticketPanel'></div>`;
  main.innerHTML=html;
  renderTicket();
}
function addToTicket(id){
  const item=appData.items.find(i=>i.id==id);
  if(!item)return;
  const ex=ticket.find(t=>t.id==id);
  if(ex)ex.qty++;else ticket.push({...item,qty:1});
  renderTicket();
}
function renderTicket(){
  const panel=document.getElementById("ticketPanel");
  let total=0, html="";
  ticket.forEach(t=>{
    const line=t.qty*t.price;
    total+=line;
    html+=`<div class='ticket-item' ontouchstart='swipeStart(event)' ontouchend='swipeEnd(event,"${t.id}")' onclick='addQty("${t.id}")'><span>${t.name} × <span class='qty'>${t.qty}</span></span><span>Ks ${line}</span></div>`;
  });
  html+=`<div class='ticket-summary'><span>Total</span><span class='ticket-total'>Ks ${total}</span></div>
  <button class='checkout-btn' onclick='checkout()'>Charge</button>`;
  panel.innerHTML=html;
}

/* Swipe & Tap Qty */
let touchX;
function swipeStart(e){touchX=e.touches[0].clientX;}
function swipeEnd(e,id){const dx=e.changedTouches[0].clientX-touchX;if(dx<-60){if(confirm("Delete item?")){ticket=ticket.filter(x=>x.id!=id);renderTicket();}}}
function addQty(id){const it=ticket.find(x=>x.id==id);if(it){it.qty++;renderTicket();}}

/* Checkout */
function checkout(){
  if(ticket.length==0)return;
  const total=ticket.reduce((s,i)=>s+i.qty*i.price,0);
  if(!confirm(`Confirm charge Ks ${total}?`))return;
  const receipt={id:Date.now(),date:new Date().toLocaleString(),items:[...ticket],total};
  appData.receipts.push(receipt);
  ticket=[]; renderTicket(); saveLocal();
  alert("✅ Sale Completed!");
}

/* ITEMS TAB */
function renderItems(){
  const main=document.querySelector("#tab-content");
  let html=`<h2>Items</h2>
  <button class='btn' onclick='addItem()'>+ Add Item</button>
  <table class='table'><tr><th>Name</th><th>Price</th><th>Category</th><th>Action</th></tr>`;
  appData.items.forEach(i=>{
    html+=`<tr><td>${i.name}</td><td>${i.price}</td><td>${i.category||""}</td>
    <td><button class='btn' onclick='editItem("${i.id}")'>Edit</button>
    <button class='btn' onclick='deleteItem("${i.id}")'>Del</button></td></tr>`;
  });
  html+="</table>";
  main.innerHTML=html;
}
function addItem(){
  const name=prompt("Item name?"); if(!name)return;
  const price=parseFloat(prompt("Price?")||0);
  const cat=prompt("Category?");
  appData.items.push({id:Date.now().toString(),name,price,category:cat});
  saveLocal(); renderItems();
}
function editItem(id){
  const it=appData.items.find(x=>x.id==id);
  if(!it)return;
  it.name=prompt("Name:",it.name)||it.name;
  it.price=parseFloat(prompt("Price:",it.price)||it.price);
  it.category=prompt("Category:",it.category||"")||it.category;
  saveLocal(); renderItems();
}
function deleteItem(id){
  if(confirm("Delete item?")){
    appData.items=appData.items.filter(x=>x.id!=id);
    saveLocal(); renderItems();
  }
}

/* CATEGORIES TAB */
function renderCategories(){
  const main=document.querySelector("#tab-content");
  let html=`<h2>Categories</h2>
  <button class='btn' onclick='addCategory()'>+ Add Category</button>
  <table class='table'><tr><th>Name</th></tr>`;
  appData.categories.forEach(c=>{
    html+=`<tr onclick='filterByCategory("${c.name}")'><td>${c.name}</td></tr>`;
  });
  html+="</table>";
  main.innerHTML=html;
}
function addCategory(){
  const name=prompt("Category name?");
  if(!name)return;
  appData.categories.push({id:Date.now(),name});
  saveLocal(); renderCategories();
}
function filterByCategory(cat){
  const tab=document.querySelector('[data-tab="sales"]');
  tab.click();
  const list=document.getElementById("salesList");
  list.querySelectorAll(".item-card").forEach(div=>{
    div.style.display=div.textContent.includes(cat)?"flex":"none";
  });
}

/* RECEIPTS TAB */
function renderReceipts(){
  const main=document.querySelector("#tab-content");
  let html="<h2>Receipts</h2><table class='table'><tr><th>Date</th><th>Total</th></tr>";
  appData.receipts.forEach(r=>{
    html+=`<tr onclick='showReceipt(${r.id})'><td>${r.date}</td><td>Ks ${r.total}</td></tr>`;
  });
  html+="</table>";
  main.innerHTML=html;
}
function showReceipt(id){
  const r=appData.receipts.find(x=>x.id==id);
  if(!r)return;
  document.getElementById("receiptTitle").textContent=`Invoice #${r.id}`;
  document.getElementById("receiptItems").innerHTML=r.items.map(i=>
    `<div style='display:flex;justify-content:space-between;'>
      <span>${i.name} × ${i.qty}</span>
      <span>Ks ${(i.qty*i.price).toLocaleString()}</span>
     </div>`).join("");
  document.getElementById("receiptTotal").textContent="Ks "+r.total;
  document.getElementById("receiptModal").classList.add("active");
}
function closeReceipt(){document.getElementById("receiptModal").classList.remove("active");}
</script>
</body>
</html>

